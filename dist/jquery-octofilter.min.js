/*
 *  jQuery Octofilter - v0.0.1
 *  A jQuery plugin to categorized suggestions.
 *  https://github.com/marcelofraga/jquery-octofilter
 *
 *  Copyright (c) 2015 Marcelo Fraga
 *  MIT License
 */
!function(a){"use strict";var b=function(b,c){this.$input=a(b),this.options=c,this.init()};b.defaults={source:{},categories:{},paramName:"query",minChars:3},b.prototype.cacheData={},b.prototype.currentData={},b.prototype.selectedFilters={},b.prototype.init=function(){var b=this;b.$input.attr({autocomplete:"off"}),b.$container=b.$input.wrap('<div class="octofilter-input"/>').parent(),b.$container.on("click",function(){b.$input.focus()}),b.$input.on("focus",function(){b.$filtersContainer.show()}).on("keydown",function(a){switch(a.keyCode||a.which){case 9:case 13:a.preventDefault();break;case 8:this.value.length||b.clear(b.$container.find(".octofilter-label:last").data("value"));break;case 27:b.$input.val("").blur(),b.$filtersContainer.hide()}}).on("keyup",function(a){switch(a.keyCode||a.which){case 9:case 13:var c=b.$filtersContainer.find(".octofilter-link.octofilter-active:first");c.length&&b.select(c.data("value"));break;default:this.value.length>=b.options.minChars?b.search(this.value):b.search("")}}),b.search("",function(){b.$filtersContainer.on("click",".octofilter-link",function(c){c.preventDefault(),c.stopPropagation(),b.select(a(this).data("value"))}),b.$container.on("click",".octofilter-clear",function(c){c.preventDefault(),c.stopPropagation(),b.clear(a(this).closest(".octofilter-label").data("value"))}),a(document).on("click",function(c){var d=a(c.target),e=d.parents().add(d);-1===e.index(b.$container)&&-1===e.index(b.$filtersContainer)&&b.$filtersContainer.hide()})})},b.prototype.makeFilterContainer=function(){var b=this;b.$filtersContainer||(b.$filtersContainer=a('<div class="octofilter-container"><ul class="nav nav-tabs"></ul><div class="tab-content"></div></div>').insertAfter(b.$input));var c=[];for(var d in b.options.categories){var e=b.options.categories[d];c.push('<li><a href="#octofilter-'+d+'" class="nav-'+d+'" data-toggle="tab">'+e+"</a></li>")}b.$filtersContainer.find(".nav").html(c).find("li:first").addClass("active")},b.prototype.populateFilterContainer=function(b){var c=this;b=a.extend({},b),a.isEmptyObject(c.options.categories)&&(a.each(b,function(a){c.options.categories[a]=a}),c.makeFilterContainer());var d=[],e=function(a){var b=a.name||a.value||a;return-1!==b.toLowerCase().indexOf(c.$input.val().toLowerCase())};c.currentData={};for(var f in c.options.categories){"string"==typeof b[f]&&(b[f]=a.parseJSON(b[f])),c.$input.val().length>=c.options.minChars&&(b[f]=a.grep(b[f],e));var g=[];if(b[f].length){for(var h in b[f]){var i="octofilter-link",j=h.name||h.value||b[f][h];-1!==a.inArray(j,c.selectedFilters[f])&&(i+=" octofiltered"),g.push(a("<a/>",{text:j,"class":i,"data-category":f,"data-value":j}))}c.currentData[f]=b[f]}else g.push(a("<span/>",{text:c.options.categories[f].toLowerCase()+" not found.","class":"octofilter-not-found"}));d.push(a("<div/>",{id:"octofilter-"+f,"class":"tab-pane"}).html(g))}c.$filtersContainer.find(".tab-content").html(d);var k,l=c.$filtersContainer.find(".octofilter-link:not(.octofiltered):first");k=l.length?l.closest(".tab-pane").addClass("active"):c.$filtersContainer.find(".tab-pane:first").addClass("active"),c.$filtersContainer.find('[href="#'+k.attr("id")+'"]').tab("show"),c.$input.val().length>=c.options.minChars&&l.addClass("octofilter-active")},b.prototype.search=function(b,c){if(this.cacheData[b])this.populateFilterContainer(this.cacheData[b]),"function"==typeof c&&c(),this.$input.trigger("octofilter.search",[this.cacheData[b]]);else if("string"==typeof this.options.source){var d=this,e={};e[this.options.paramName]=b,a.getJSON(this.options.source,e,function(a){d.cacheData[b]=a,d.$filtersContainer||d.makeFilterContainer(),d.populateFilterContainer(a),"function"==typeof c&&c(),d.$input.trigger("octofilter.search",[a])})}else this.$filtersContainer||this.makeFilterContainer(),this.populateFilterContainer(this.options.source),"function"==typeof c&&c(),this.$input.trigger("octofilter.search",[this.currentData])},b.prototype.select=function(b){var c=this,d=c.$filtersContainer.find('.octofilter-link[data-value="'+b+'"]'),e=d.data("category");if(-1!==a.inArray(b,c.selectedFilters[e]))return void c.$input.focus();c.selectedFilters[e]||(c.selectedFilters[e]=[]),c.selectedFilters[e].push(b);var f=a("<span/>",{"class":"octofilter-label",text:d.text(),"data-value":b,"data-category":e});a("<a/>",{"class":"octofilter-clear",html:"&times;"}).appendTo(f);var g=c.$container.find(".octofilter-label");g.length?g.last().after(f):c.$container.prepend(f),c.$input.val("").focus(),c.search(""),c.$input.trigger("octofilter.select",[c.selectedFilters])},b.prototype.clear=function(a){var b=this,c={};if(a){var d=b.$container.find('.octofilter-label[data-value="'+a+'"]').remove(),e=d.data("category");c[e]=b.selectedFilters[e].splice(b.selectedFilters[e].indexOf(a),1)}else b.$container.find(".octofilter-label").remove(),b.selectedFilters={},b.$input.val("");b.$input.focus(),b.search(b.$input.val()),b.$input.trigger("octofilter.clear",[c])},a.fn.octofilter=function(c){return this.each(function(){var d=a(this),e=d.data("octofilter"),f=a.extend({},b.defaults,d.data(),"object"==typeof c&&c);e||d.data("octofilter",new b(this,f)),"string"==typeof c&&e[c]()})},a.fn.octofilter.Constructor=b}(window.jQuery);